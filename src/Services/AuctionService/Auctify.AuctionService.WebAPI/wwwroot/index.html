<!DOCTYPE html>
<html>
<body>
    <h1>Auctify Canlı Takip</h1>
    <h3>Fiyat: <span id="price">100.00 TL</span></h3>
    <hr>
    <div>
        <label for="bidAmount">Teklifiniz:</label>
        <input type="number" id="bidAmount" value="110" style="width: 80px;">
        <button id="submitBid">Teklif Ver</button>
        <span id="status" style="margin-left: 10px; color: blue;"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script>
        // --- MEVCUT KOD ---
        const connection = new signalR.HubConnectionBuilder().withUrl("/auctionHub").build();

        connection.on("NewBidReceived", (auctionId, newPrice) => {
            if (auctionId === "nadir-pulu") {
                document.getElementById("price").innerText = newPrice.toFixed(2) + " TL";

                // --- GELİŞTİRME 1: Durum mesajı ve yeni teklif önerisi ---
                document.getElementById("status").innerText = `✓ Teklif alındı! Yeni Fiyat: ${newPrice.toFixed(2)} TL`;
                document.getElementById("bidAmount").value = Math.ceil(newPrice + 10);
            }
        });

        // --- YENİ EKLENEN KOD ---
        const auctionId = "nadir-pulu";
        const bidButton = document.getElementById("submitBid");
        const bidAmountInput = document.getElementById("bidAmount");
        const statusElement = document.getElementById("status");

        // "Teklif Ver" butonuna tıklama olayını dinle
        bidButton.addEventListener("click", async () => {
            const amount = parseFloat(bidAmountInput.value);

            statusElement.innerText = "Gönderiliyor...";
            try {
                // API'ye POST isteği gönder
                const response = await fetch(`/api/auctions/${auctionId}/bid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(amount)
                });

                if (!response.ok) {
                    // API'den gelen hata mesajını göster
                    const error = await response.json();
                    statusElement.innerText = `✗ Hata: ${error.Message}`;
                }
                // Başarılı olursa, SignalR'dan gelen mesaj durumu zaten güncelleyecek.
                // O yüzden burada ayrıca bir başarı mesajı yazmaya gerek yok.

            } catch (err) {
                console.error('API Hatası:', err);
                statusElement.innerText = "✗ Sunucu hatası!";
            }
        });

        // --- MEVCUT KOD (Başlatma) ---
        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
                statusElement.innerText = "Bağlantı kuruldu.";
            } catch (err) {
                console.log(err);
                setTimeout(startConnection, 5000);
            }
        }

        startConnection();
    </script>
</body>
</html>